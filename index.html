<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project 45 â€“ Study Material</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Notification Bell Icon CSS -->
<style>
:root {
  --bg1: #041024;
  --bg2: #071226;
  --glass: rgba(255,255,255,0.06);
  --accent: #10b981;
  --card-bg: rgba(255,255,255,0.05);
}

body {
  background: linear-gradient(180deg, var(--bg1), var(--bg2));
  min-height: 100vh;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

/* Notification Bell */
.notification-bell {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.4);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
}

.notification-bell:hover {
  transform: scale(1.1);
  background: rgba(16, 185, 129, 0.3);
}

.notification-bell i {
  font-size: 22px;
  color: #10b981;
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

/* Notification Panel */
.notification-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 999;
  width: 350px;
  max-height: 500px;
  overflow-y: auto;
  background: rgba(15, 27, 51, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  display: none;
}

.notification-header {
  padding: 15px;
  border-bottom: 1px solid rgba(16, 185, 129, 0.3);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-header h3 {
  font-weight: 600;
  color: #10b981;
  font-size: 18px;
}

.clear-all-btn {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.4);
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.clear-all-btn:hover {
  background: rgba(239, 68, 68, 0.3);
}

.notification-list {
  padding: 10px;
}

.notification-item {
  background: rgba(30, 41, 59, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  border-left: 4px solid #10b981;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.notification-item.unread {
  background: rgba(16, 185, 129, 0.1);
  border-left-color: #f59e0b;
}

.notification-title {
  font-weight: 600;
  color: #e2e8f0;
  margin-bottom: 5px;
  font-size: 14px;
}

.notification-message {
  color: #94a3b8;
  font-size: 13px;
  line-height: 1.4;
}

.notification-time {
  font-size: 11px;
  color: #64748b;
  margin-top: 8px;
  text-align: right;
}

.no-notifications {
  text-align: center;
  padding: 30px;
  color: #94a3b8;
}

/* Banner */
.banner-slide {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 16px;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--glass);
  transition: .3s;
}
.card:hover { transform: translateY(-6px); }

.poster {
  width: 100%;
  height: 160px;
  object-fit: cover;
}

.tab-btn {
  border-radius: 10px;
  padding: 8px 16px;
  background: #0f1b33;
  color: #e2e8f0;
  font-weight: 600;
  border: 1px solid #1f2d4d;
  transition: all 0.3s;
}

.tab-btn.active {
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #071226;
}

.open-link {
  display:inline-block;
  padding:8px 12px;
  background:linear-gradient(90deg,#0ea5a4,#10b981);
  color:#071226;
  margin-top:10px;
  border-radius:8px;
  font-weight:600;
  cursor: pointer;
}

/* LECTURE PLAYER STYLES */
.lecture-player-section {
  max-width: 1200px;
  margin: 0 auto;
}

.lecture-controls {
  background: #0f1b33;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid #1f2d4d;
}

.lecture-input-section {
  display: none; /* Hidden as requested */
}

.lecture-player-container {
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
  border: 2px solid #1f2d4d;
  position: relative;
  aspect-ratio: 16 / 9; /* 16:9 aspect ratio */
  width: 100%;
}

.lecture-player {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
}

.lecture-features {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

.lecture-feature-btn {
  padding: 10px 20px;
  background: #0f1b33;
  color: #e2e8f0;
  border: 1px solid #1f2d4d;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  min-width: 90px;
  justify-content: center;
}

.lecture-feature-btn:hover {
  background: #1a2747;
}

.lecture-feature-btn.active {
  background: #10b981;
  color: #071226;
}

/* Lecture List */
.lecture-list {
  margin-top: 30px;
}

.lectures-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.lecture-card {
  background: #0f1b33;
  border: 1px solid #1f2d4d;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s;
}

.lecture-card:hover {
  transform: translateY(-5px);
  border-color: #10b981;
  box-shadow: 0 10px 20px rgba(16, 185, 129, 0.1);
}

.lecture-thumbnail {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-bottom: 1px solid #1f2d4d;
}

.lecture-card-content {
  padding: 15px;
}

.lecture-card-title {
  font-weight: 600;
  color: #e2e8f0;
  margin-bottom: 8px;
  font-size: 16px;
  line-height: 1.4;
}

.lecture-card-description {
  font-size: 13px;
  color: #94a3b8;
  margin-bottom: 15px;
  line-height: 1.5;
}

.lecture-card-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}

.lecture-card-subject {
  font-size: 12px;
  padding: 4px 10px;
  background: rgba(16, 185, 129, 0.1);
  color: #10b981;
  border-radius: 20px;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.play-lecture-btn {
  padding: 8px 20px;
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #071226;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  width: 100%;
  justify-content: center;
  margin-top: 10px;
}

.play-lecture-btn:hover {
  opacity: 0.9;
  transform: scale(1.05);
}

.play-lecture-btn-small {
  padding: 6px 15px;
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #071226;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
}

.play-lecture-btn-small:hover {
  opacity: 0.9;
}

.no-lectures {
  text-align: center;
  padding: 40px;
  color: #94a3b8;
  background: #0f1b33;
  border-radius: 12px;
  border: 1px solid #1f2d4d;
  grid-column: 1 / -1;
}

.lecture-count {
  color: #10b981;
  font-weight: 600;
  margin-left: 5px;
}

/* Hidden URL Display */
.hidden-url {
  display: none;
}

/* POPUP */
#popup {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.popup-box {
  background: #0f1b33;
  padding: 25px;
  width: 90%;
  max-width: 380px;
  border-radius: 18px;
  text-align: center;
  border: 1px solid #1f2d4d;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.popup-thumb {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 12px;
  margin: 15px 0;
  border: 2px solid #10b981;
}
.close-btn {
  margin-top: 20px;
  padding: 10px 24px;
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #0f1b33;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  border: none;
  width: 100%;
}

/* Responsive */
@media (max-width: 640px) {
  .notification-panel {
    width: calc(100vw - 40px);
    right: 10px;
    left: 10px;
  }
  
  .notification-bell {
    top: 10px;
    right: 10px;
    width: 45px;
    height: 45px;
  }
  
  .lectures-grid {
    grid-template-columns: 1fr;
  }
  
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body class="text-white">

<!-- Notification Bell -->
<div class="notification-bell" onclick="toggleNotificationPanel()">
  <i class="fas fa-bell"></i>
  <div id="notification-badge" class="notification-badge" style="display: none;">0</div>
</div>

<!-- Notification Panel -->
<div id="notification-panel" class="notification-panel">
  <div class="notification-header">
    <h3>Notifications</h3>
    <button onclick="clearAllNotifications()" class="clear-all-btn">
      Clear All
    </button>
  </div>
  <div id="notification-list" class="notification-list">
    <div class="no-notifications">
      <i class="fas fa-bell-slash text-3xl mb-3"></i>
      <p>No notifications yet</p>
    </div>
  </div>
</div>

<header class="p-4 text-center text-3xl font-bold text-emerald-400">
  Project 45 â€“ Study Resources
</header>

<!-- POPUP -->
<div id="popup">
  <div class="popup-box">
    <h2 class="text-xl font-bold mb-2">ðŸŽ‰ New Lecture Added!</h2>
    <img id="popup-thumb" class="popup-thumb" src="https://via.placeholder.com/350x180/0f1b33/10b981?text=Lecture+Thumbnail">
    <p id="popup-title" class="mt-3 text-lg font-semibold text-emerald-300"></p>
    <button class="close-btn" onclick="closePopup()">Continue</button>
  </div>
</div>

<!-- BANNERS -->
<div id="banner-area" class="p-4 space-y-4"></div>

<!-- CATEGORY SELECT -->
<div class="p-4">
  <label class="text-gray-300 text-lg">Select Category:</label>
  <select id="category-filter" class="w-full p-3 rounded bg-[#0d1a33] border border-[#1a2747] text-white mt-2"></select>
</div>

<!-- TABS -->
<div class="flex justify-center gap-2 my-4 px-4 flex-wrap">
  <button class="tab-btn active" onclick="showSection('projects')">Projects</button>
  <button class="tab-btn" onclick="showSection('notes')">Notes</button>
  <button class="tab-btn" onclick="showSection('dpp')">DPP</button>
  <button class="tab-btn" onclick="showSection('lecture')">Lecture Player</button>
</div>

<div class="p-4">

  <!-- PROJECTS -->
  <div id="projects-section" class="section">
    <h2 class="text-xl font-bold mb-4 text-emerald-300">Projects</h2>
    <div id="projects-list" class="grid grid-cols-2 gap-4"></div>
  </div>

  <!-- NOTES -->
  <div id="notes-section" class="section hidden">
    <h2 class="text-xl font-bold mb-4 text-emerald-300">Notes</h2>
    <div id="notes-list" class="grid grid-cols-2 gap-4"></div>
  </div>

  <!-- DPP -->
  <div id="dpp-section" class="section hidden">
    <h2 class="text-xl font-bold mb-4 text-emerald-300">Daily Practice Papers</h2>
    <div id="dpp-list" class="grid grid-cols-2 gap-4"></div>
  </div>

  <!-- LECTURE PLAYER -->
  <div id="lecture-section" class="section hidden lecture-player-section">
    <h2 class="text-xl font-bold mb-6 text-emerald-300 text-center">Lecture Player</h2>
    
    <!-- Hidden URL input (not visible to user) -->
    <div class="hidden-url">
      <input type="text" id="lectureUrl" value="">
    </div>
    
    <!-- 16:9 Video Player -->
    <div class="lecture-player-container">
      <div id="lecture-player"></div>
    </div>
    
    <!-- Speed Controls -->
    <div class="lecture-features">
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(0.75)">
        0.75x
      </button>
      <button class="lecture-feature-btn active" onclick="setPlaybackSpeed(1)">
        1x (Normal)
      </button>
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(1.25)">
        1.25x
      </button>
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(1.5)">
        1.5x
      </button>
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(2)">
        2x
      </button>
      <button class="lecture-feature-btn" onclick="skipBackward()">
        -15s
      </button>
      <button class="lecture-feature-btn" onclick="skipForward()">
        +15s
      </button>
    </div>
    
    <!-- All Lectures from Firebase -->
    <div class="lecture-list">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-emerald-300">All Lectures <span id="lecture-count" class="lecture-count">0</span></h3>
        <div class="text-sm text-gray-400">
          Click any lecture to play
        </div>
      </div>
      <div id="lectures-grid-container" class="lectures-grid">
        <!-- All lectures will be loaded here from Firebase -->
        <div class="no-lectures">
          <i class="fas fa-video-slash text-4xl mb-3"></i>
          <p>No lectures added yet. Add lectures in Firebase to see them here.</p>
          <p class="text-sm mt-2">Add lectures in the "lectures" node in your Firebase database</p>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// ---------------- FIREBASE ----------------
const firebaseConfig = {
  apiKey: "AIzaSyA8Ck4k7gMfn9oU1nq-JBijML1JE6yVx84",
  authDomain: "project45-627cc.firebaseapp.com",
  databaseURL: "https://project45-627cc-default-rtdb.firebaseio.com",
  projectId: "project45-627cc",
  storageBucket: "project45-627cc.appspot.com",
  messagingSenderId: "850515567224",
  appId: "1:850515567224:web:bcbed252ee8596c08fc38d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let allCategories = {}, allProjects = {}, allNotes = {}, allDpp = {}, allLectures = {};
let allNotifications = {};
let unreadNotifications = 0;

// Store lecture to play when switching to lecture tab
let lectureToPlay = null;

// Notification Functions
function toggleNotificationPanel() {
  const panel = document.getElementById('notification-panel');
  if (panel.style.display === 'block') {
    panel.style.display = 'none';
  } else {
    panel.style.display = 'block';
    // Mark all as read when opened
    markAllAsRead();
  }
}

function markAllAsRead() {
  unreadNotifications = 0;
  updateNotificationBadge();
  
  // Update UI to remove unread styling
  document.querySelectorAll('.notification-item.unread').forEach(item => {
    item.classList.remove('unread');
  });
}

function clearAllNotifications() {
  if (confirm('Clear all notifications?')) {
    // In a real app, you might want to archive them instead
    document.getElementById('notification-list').innerHTML = `
      <div class="no-notifications">
        <i class="fas fa-bell-slash text-3xl mb-3"></i>
        <p>No notifications yet</p>
      </div>
    `;
    unreadNotifications = 0;
    updateNotificationBadge();
  }
}

function updateNotificationBadge() {
  const badge = document.getElementById('notification-badge');
  if (unreadNotifications > 0) {
    badge.style.display = 'flex';
    badge.textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
  } else {
    badge.style.display = 'none';
  }
}

function showNotification(title, message) {
  // Create notification item
  const notificationList = document.getElementById('notification-list');
  
  // Remove "no notifications" message if present
  const noNotifications = notificationList.querySelector('.no-notifications');
  if (noNotifications) {
    noNotifications.remove();
  }
  
  // Format time
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
  
  // Create notification element
  const notificationDiv = document.createElement('div');
  notificationDiv.className = 'notification-item unread';
  notificationDiv.innerHTML = `
    <div class="notification-title">${title}</div>
    <div class="notification-message">${message}</div>
    <div class="notification-time">${timeStr}</div>
  `;
  
  // Add to top of list
  notificationList.insertBefore(notificationDiv, notificationList.firstChild);
  
  // Update badge
  unreadNotifications++;
  updateNotificationBadge();
  
  // Show desktop notification if supported
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(title, { body: message, icon: '/favicon.ico' });
  }
  
  // Auto-remove after 10 seconds if not opened
  setTimeout(() => {
    if (notificationDiv.classList.contains('unread')) {
      notificationDiv.classList.remove('unread');
    }
  }, 10000);
}

// Request notification permission
function requestNotificationPermission() {
  if ("Notification" in window) {
    if (Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        console.log("Notification permission:", permission);
      });
    }
  }
}

// Check for scheduled notifications
function checkScheduledNotifications() {
  const now = new Date();
  const currentHour = now.getHours();
  const currentMinute = now.getMinutes();
  
  Object.values(allNotifications || {}).forEach(notification => {
    if (notification.active && 
        notification.hour === currentHour && 
        notification.minute === currentMinute) {
      
      // Check if we already showed this notification today
      const lastShownKey = `last_shown_${notification.hour}_${notification.minute}`;
      const lastShown = localStorage.getItem(lastShownKey);
      const today = now.toDateString();
      
      if (lastShown !== today) {
        // Show notification
        showNotification(notification.title, notification.message);
        
        // Store that we showed it today
        localStorage.setItem(lastShownKey, today);
      }
    }
  });
}

function showSection(sec){
  // Update tab buttons
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.classList.remove("active");
  });
  event.currentTarget.classList.add("active");
  
  // Show selected section
  document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
  document.getElementById(sec + "-section").classList.remove("hidden");
  
  // If switching to lecture tab and there's a lecture to play
  if (sec === 'lecture' && lectureToPlay) {
    // Small delay to ensure player is loaded
    setTimeout(() => {
      playLecture(lectureToPlay.videoId, lectureToPlay.title);
      lectureToPlay = null; // Reset after playing
    }, 500);
  }
}

// -------------- POPUP -----------------
function openPopup(title, thumb){
  document.getElementById("popup-title").innerText = title;
  document.getElementById("popup-thumb").src = thumb;
  document.getElementById("popup").style.display = "flex";
}

function closePopup(){
  document.getElementById("popup").style.display = "none";
}

// ----------- BANNERS ----------- 
function loadBanners(){
  const area = document.getElementById("banner-area");
  area.innerHTML = "";

  db.ref("banners").on("value", snap => {
    area.innerHTML = "";
    snap.forEach(child => {
      const url = child.val().url;
      if(url) {
        area.innerHTML += `<img src="${url}" class="banner-slide">`;
      }
    });
    
    // If no banners, show placeholder
    if(area.innerHTML === "") {
      area.innerHTML = `
        <div class="banner-slide bg-gradient-to-r from-emerald-900 to-teal-800 flex items-center justify-center">
          <p class="text-xl font-bold">Study Resources</p>
        </div>
      `;
    }
  });
}

// ----------- CATEGORY DROPDOWN ----------- 
function loadCategories(){
  const select = document.getElementById("category-filter");
  select.innerHTML = `<option value="">All Categories</option>`;

  db.ref("categories").on("value", snap => {
    select.innerHTML = `<option value="">All Categories</option>`;
    snap.forEach(child => {
      const name = child.val().name;
      allCategories[child.key] = name;
      select.innerHTML += `<option value="${name}">${name}</option>`;
    });
    renderAll();
  });

  select.addEventListener("change", renderAll);
}

// ----------- PROJECTS (WITH LECTURE LINKS) ----------- 
function renderProjects(){
  const list = document.getElementById("projects-list");
  const filter = document.getElementById("category-filter").value;
  list.innerHTML = "";

  Object.entries(allProjects).forEach(([id, p]) => {
    if(filter && p.category !== filter) return;

    // Check if this project has a video URL (lecture)
    const hasLecture = p.videoUrl || p.lectureUrl || p.watchLink;
    const videoId = extractVideoIdFromUrl(hasLecture);
    
    list.innerHTML += `
      <div class="card">
        <img src="${p.posterUrl || 'https://via.placeholder.com/300x160/0f1b33/10b981?text=Project'}" 
             class="poster" alt="${p.title}">
        <div class="p-3">
          <p class="font-bold text-sm">${p.title}</p>
          <p class="text-gray-400 text-xs mt-1">${p.year || ''}</p>
          ${hasLecture && videoId ? 
            `<button onclick="playLectureFromHome('${videoId}', '${p.title.replace(/'/g, "\\'")}')" class="open-link text-xs w-full text-center">Watch Lecture</button>` : 
            '<p class="text-gray-500 text-xs mt-2">No lecture available</p>'
          }
        </div>
      </div>
    `;
  });
  
  if(list.innerHTML === "") {
    list.innerHTML = `<p class="col-span-2 text-center text-gray-400 p-4">No projects found</p>`;
  }
}

// ----------- NOTES ----------- 
function renderNotes(){
  const list = document.getElementById("notes-list");
  const filter = document.getElementById("category-filter").value;
  list.innerHTML = "";

  Object.entries(allNotes).forEach(([id, n]) => {
    if(filter && n.category !== filter) return;

    list.innerHTML += `
      <div class="card p-3">
        <p class="font-bold text-sm mb-2">${n.title}</p>
        ${n.url ? 
          `<a href="${n.url}" target="_blank" class="open-link text-xs">Open Notes</a>` : 
          '<p class="text-gray-500 text-xs">Link coming soon</p>'
        }
      </div>
    `;
  });
  
  if(list.innerHTML === "") {
    list.innerHTML = `<p class="col-span-2 text-center text-gray-400 p-4">No notes found</p>`;
  }
}

// ----------- DPP ----------- 
function renderDpp(){
  const list = document.getElementById("dpp-list");
  const filter = document.getElementById("category-filter").value;
  list.innerHTML = "";

  Object.entries(allDpp).forEach(([id, d]) => {
    if(filter && d.category !== filter) return;

    list.innerHTML += `
      <div class="card p-3">
        <p class="font-bold text-sm mb-2">${d.title}</p>
        ${d.url ? 
          `<a href="${d.url}" target="_blank" class="open-link text-xs">Open DPP</a>` : 
          '<p class="text-gray-500 text-xs">Link coming soon</p>'
        }
      </div>
    `;
  });
  
  if(list.innerHTML === "") {
    list.innerHTML = `<p class="col-span-2 text-center text-gray-400 p-4">No DPP found</p>`;
  }
}

// ----------- ALL LECTURES ----------- 
function renderAllLectures() {
  const grid = document.getElementById("lectures-grid-container");
  const countElement = document.getElementById("lecture-count");
  
  // Convert to array
  const lecturesArray = Object.entries(allLectures);
  
  // Update count
  countElement.textContent = lecturesArray.length;
  
  if (lecturesArray.length === 0) {
    grid.innerHTML = `
      <div class="no-lectures">
        <i class="fas fa-video-slash text-4xl mb-3"></i>
        <p>No lectures added yet. Add lectures in Firebase to see them here.</p>
        <p class="text-sm mt-2">Add lectures in the "lectures" node in your Firebase database</p>
      </div>
    `;
    return;
  }
  
  // Sort by timestamp if available, otherwise show in reverse order (newest first)
  lecturesArray.sort((a, b) => {
    const timeA = a[1].timestamp || a[1].createdAt || 0;
    const timeB = b[1].timestamp || b[1].createdAt || 0;
    return timeB - timeA; // Newest first
  });
  
  // Clear grid
  grid.innerHTML = '';
  
  // Display all lectures in grid
  lecturesArray.forEach(([id, lecture]) => {
    const videoId = extractVideoIdFromUrl(lecture.videoUrl || lecture.url || lecture.watchLink);
    if (!videoId) return; // Skip if no valid video ID
    
    // Get YouTube thumbnail
    const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    
    // Get subject/tag
    const subject = lecture.subject || lecture.category || 'General';
    
    // Format description (limit length)
    const description = lecture.description 
      ? (lecture.description.length > 100 
        ? lecture.description.substring(0, 100) + '...' 
        : lecture.description)
      : 'Educational lecture video';
    
    grid.innerHTML += `
      <div class="lecture-card">
        <img src="${thumbnailUrl}" 
             class="lecture-thumbnail" 
             alt="${lecture.title || 'Lecture'}"
             onerror="this.src='https://via.placeholder.com/300x180/0f1b33/10b981?text=Lecture'">
        <div class="lecture-card-content">
          <h4 class="lecture-card-title">${lecture.title || 'Untitled Lecture'}</h4>
          <p class="lecture-card-description">${description}</p>
          
          <div class="lecture-card-meta">
            <span class="lecture-card-subject">${subject}</span>
            <span class="text-xs text-gray-400">
              ${lecture.duration || '--:--'}
            </span>
          </div>
          
          <button class="play-lecture-btn" 
                  onclick="playLecture('${videoId}', '${(lecture.title || 'Untitled').replace(/'/g, "\\'")}')">
            <i class="fas fa-play"></i> Play Lecture
          </button>
        </div>
      </div>
    `;
  });
}

let firstLoad = true;

// ----------- LIVE FIREBASE DATA ----------- 
function startLive() {
  // Load projects
  db.ref("projects").on("value", snap => {
    const oldCount = Object.keys(allProjects).length;
    allProjects = snap.val() || {};
    const newCount = Object.keys(allProjects).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allProjects).slice(-1)[0];
      const thumbnail = lastItem.posterUrl || 
                       "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Project";
      openPopup(lastItem.title || "New Project Added", thumbnail);
    }
    renderProjects();
  });

  // Load notes
  db.ref("notes").on("value", snap => {
    const oldCount = Object.keys(allNotes).length;
    allNotes = snap.val() || {};
    const newCount = Object.keys(allNotes).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allNotes).slice(-1)[0];
      const thumbnail = lastItem.thumbnail || 
                       lastItem.posterUrl || 
                       "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Notes";
      openPopup(lastItem.title || "New Notes Added", thumbnail);
    }
    renderNotes();
  });

  // Load DPP
  db.ref("dpp").on("value", snap => {
    const oldCount = Object.keys(allDpp).length;
    allDpp = snap.val() || {};
    const newCount = Object.keys(allDpp).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allDpp).slice(-1)[0];
      const thumbnail = lastItem.thumbnail || 
                       lastItem.posterUrl || 
                       "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+DPP";
      openPopup(lastItem.title || "New DPP Added", thumbnail);
    }
    renderDpp();
  });

  // Load ALL lectures from Firebase
  db.ref("lectures").on("value", snap => {
    const oldCount = Object.keys(allLectures).length;
    allLectures = snap.val() || {};
    const newCount = Object.keys(allLectures).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allLectures).slice(-1)[0];
      const videoId = extractVideoIdFromUrl(lastItem.videoUrl || lastItem.url || lastItem.watchLink);
      const thumbnail = videoId 
        ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`
        : lastItem.thumbnail || 
          lastItem.posterUrl || 
          "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Lecture";
      
      openPopup(lastItem.title || "New Lecture Added", thumbnail);
    }
    
    // Render all lectures in grid
    renderAllLectures();
    
    // Auto-play first lecture if none is playing
    if (lecturePlayer && (!lecturePlayer.getVideoData || !lecturePlayer.getVideoData().video_id)) {
      const lecturesArray = Object.values(allLectures);
      if (lecturesArray.length > 0) {
        const firstLecture = lecturesArray[0];
        const videoId = extractVideoIdFromUrl(firstLecture.videoUrl || firstLecture.url || firstLecture.watchLink);
        if (videoId && !document.getElementById('lectureUrl').value) {
          document.getElementById('lectureUrl').value = videoId;
          if (lecturePlayer.loadVideoById) {
            lecturePlayer.loadVideoById(videoId);
          }
        }
      }
    }
  });

  // Load notifications
  db.ref("notifications").on("value", snap => {
    allNotifications = snap.val() || {};
    
    // Load existing notifications from localStorage
    loadSavedNotifications();
    
    // Start checking for scheduled notifications
    setInterval(checkScheduledNotifications, 60000); // Check every minute
  });

  firstLoad = false;
}

// Load saved notifications from localStorage
function loadSavedNotifications() {
  const saved = localStorage.getItem('project45_notifications');
  if (saved) {
    try {
      const notifications = JSON.parse(saved);
      const notificationList = document.getElementById('notification-list');
      
      if (notifications.length > 0) {
        notificationList.innerHTML = '';
        notifications.forEach(notif => {
          const div = document.createElement('div');
          div.className = 'notification-item';
          if (notif.unread) div.classList.add('unread');
          
          div.innerHTML = `
            <div class="notification-title">${notif.title}</div>
            <div class="notification-message">${notif.message}</div>
            <div class="notification-time">${notif.time}</div>
          `;
          
          notificationList.appendChild(div);
        });
      }
    } catch (e) {
      console.error('Error loading saved notifications:', e);
    }
  }
}

// Save notifications to localStorage
function saveNotifications() {
  const notifications = [];
  document.querySelectorAll('.notification-item').forEach(item => {
    const title = item.querySelector('.notification-title').textContent;
    const message = item.querySelector('.notification-message').textContent;
    const time = item.querySelector('.notification-time').textContent;
    const unread = item.classList.contains('unread');
    
    notifications.push({ title, message, time, unread });
  });
  
  localStorage.setItem('project45_notifications', JSON.stringify(notifications));
}

function renderAll() {
  renderProjects();
  renderNotes();
  renderDpp();
}

// ================= LECTURE PLAYER =================
// Load YouTube IFrame API
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var lecturePlayer;
let currentSpeed = 1;

function extractVideoIdFromUrl(url) {
  if (!url) return null;
  
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
    /^([a-zA-Z0-9_-]{11})$/
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return match[1];
    }
  }
  
  return null;
}

function onYouTubeIframeAPIReady() {
  lecturePlayer = new YT.Player('lecture-player', {
    height: '100%',
    width: '100%',
    videoId: '', // Start empty
    playerVars: {
      'autoplay': 0,
      'controls': 1,
      'rel': 0,
      'modestbranding': 1,
      'showinfo': 0,
      'iv_load_policy': 3,
      'enablejsapi': 1
    },
    events: {
      'onReady': onLecturePlayerReady,
      'onStateChange': onLectureStateChange
    }
  });
}

function onLecturePlayerReady(event) {
  console.log("Lecture Player ready");
  // Set initial playback speed
  event.target.setPlaybackRate(currentSpeed);
  
  // Load first lecture if available
  const lecturesArray = Object.values(allLectures);
  if (lecturesArray.length > 0) {
    const firstLecture = lecturesArray[0];
    const videoId = extractVideoIdFromUrl(firstLecture.videoUrl || firstLecture.url || firstLecture.watchLink);
    if (videoId) {
      document.getElementById('lectureUrl').value = videoId;
      event.target.loadVideoById(videoId);
    }
  }
}

function onLectureStateChange(event) {
  // Player state change handler
}

function playLecture(videoId, title = '') {
  if (!videoId) return;
  
  // Set the hidden input value
  document.getElementById('lectureUrl').value = videoId;
  
  // Load and play the video
  if (lecturePlayer && lecturePlayer.loadVideoById) {
    lecturePlayer.loadVideoById(videoId);
    lecturePlayer.setPlaybackRate(currentSpeed);
    
    // Update page title if provided
    if (title) {
      document.title = `Playing: ${title} - Project 45`;
    }
    
    // Scroll player into view
    document.querySelector('.lecture-player-container').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }
}

function playLectureFromHome(videoId, title) {
  // Store lecture info and switch to lecture tab
  lectureToPlay = { videoId, title };
  showSection('lecture');
}

function setPlaybackSpeed(speed) {
  currentSpeed = speed;
  if (lecturePlayer && lecturePlayer.setPlaybackRate) {
    lecturePlayer.setPlaybackRate(speed);
  }
  
  // Update active button
  document.querySelectorAll('.lecture-feature-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
}

function skipBackward() {
  if (!lecturePlayer || !lecturePlayer.getCurrentTime) return;
  const currentTime = lecturePlayer.getCurrentTime();
  lecturePlayer.seekTo(Math.max(0, currentTime - 15), true);
}

function skipForward() {
  if (!lecturePlayer || !lecturePlayer.getCurrentTime) return;
  const currentTime = lecturePlayer.getCurrentTime();
  lecturePlayer.seekTo(currentTime + 15, true);
}

// INITIALIZE EVERYTHING
window.onload = function() {
  loadBanners();
  loadCategories();
  startLive();
  
  // Show projects by default
  showSection('projects');
  
  // Request notification permission
  requestNotificationPermission();
  
  // Add error handling for popup image
  document.getElementById('popup-thumb').onerror = function() {
    this.src = "https://via.placeholder.com/350x180/0f1b33/10b981?text=Content+Added";
  };
  
  // Add error handling for lecture thumbnails
  document.addEventListener('error', function(e) {
    if (e.target.classList.contains('lecture-thumbnail')) {
      e.target.src = 'https://via.placeholder.com/300x180/0f1b33/10b981?text=Lecture';
    }
  }, true);
  
  // Close notification panel when clicking outside
  document.addEventListener('click', function(event) {
    const panel = document.getElementById('notification-panel');
    const bell = document.querySelector('.notification-bell');
    
    if (panel.style.display === 'block' && 
        !panel.contains(event.target) && 
        !bell.contains(event.target)) {
      panel.style.display = 'none';
    }
  });
  
  // Test notification (can be removed)
  setTimeout(() => {
    showNotification("Welcome to Project 45!", "Start exploring study resources and lectures. Good luck with your preparation!");
  }, 2000);
};
</script>

</body>
</html>
