<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project 45 â€“ Study Material</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
:root {
  --bg1: #041024;
  --bg2: #071226;
  --glass: rgba(255,255,255,0.06);
  --accent: #10b981;
  --card-bg: rgba(255,255,255,0.05);
}

body {
  background: linear-gradient(180deg, var(--bg1), var(--bg2));
  min-height: 100vh;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

/* Notification System */
.notification-bell {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.4);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
}

.notification-bell:hover {
  transform: scale(1.1);
  background: rgba(16, 185, 129, 0.3);
}

.notification-bell i {
  font-size: 22px;
  color: #10b981;
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  border: 2px solid var(--bg1);
}

/* Notification Panel */
.notification-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 999;
  width: 380px;
  max-height: 500px;
  overflow-y: auto;
  background: rgba(15, 27, 51, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 16px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  display: none;
}

.notification-header {
  padding: 18px;
  border-bottom: 1px solid rgba(16, 185, 129, 0.3);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(30, 41, 59, 0.5);
  border-radius: 16px 16px 0 0;
}

.notification-header h3 {
  font-weight: 700;
  color: #10b981;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.notification-actions {
  display: flex;
  gap: 8px;
}

.clear-all-btn, .mark-read-btn {
  background: rgba(30, 41, 59, 0.8);
  color: #94a3b8;
  border: 1px solid rgba(16, 185, 129, 0.2);
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.clear-all-btn:hover {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border-color: rgba(239, 68, 68, 0.4);
}

.mark-read-btn:hover {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
  border-color: rgba(16, 185, 129, 0.4);
}

.notification-list {
  padding: 0;
}

.notification-item {
  padding: 16px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  transition: all 0.3s;
  cursor: pointer;
  position: relative;
}

.notification-item:last-child {
  border-bottom: none;
}

.notification-item:hover {
  background: rgba(16, 185, 129, 0.05);
}

.notification-item.unread {
  background: linear-gradient(90deg, rgba(16, 185, 129, 0.08), transparent);
  border-left: 4px solid #10b981;
}

.notification-item.unread::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
  70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
  100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.notification-content {
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.notification-icon {
  font-size: 20px;
  margin-top: 2px;
}

.notification-text {
  flex: 1;
}

.notification-title {
  font-weight: 600;
  color: #e2e8f0;
  margin-bottom: 6px;
  font-size: 14px;
  line-height: 1.4;
}

.notification-message {
  color: #94a3b8;
  font-size: 13px;
  line-height: 1.5;
}

.notification-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}

.notification-time {
  font-size: 11px;
  color: #64748b;
}

.notification-type {
  font-size: 11px;
  padding: 2px 8px;
  background: rgba(16, 185, 129, 0.1);
  color: #10b981;
  border-radius: 12px;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.no-notifications {
  text-align: center;
  padding: 40px 20px;
  color: #94a3b8;
}

.no-notifications i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.no-notifications p {
  font-size: 14px;
}

/* Banner */
.banner-slide {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 16px;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--glass);
  transition: .3s;
}
.card:hover { transform: translateY(-6px); }

.poster {
  width: 100%;
  height: 160px;
  object-fit: cover;
}

.tab-btn {
  border-radius: 10px;
  padding: 10px 20px;
  background: #0f1b33;
  color: #e2e8f0;
  font-weight: 600;
  border: 1px solid #1f2d4d;
  transition: all 0.3s;
  cursor: pointer;
  font-size: 14px;
}

.tab-btn.active {
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #071226;
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.open-link {
  display:inline-block;
  padding:8px 12px;
  background:linear-gradient(90deg,#0ea5a4,#10b981);
  color:#071226;
  margin-top:10px;
  border-radius:8px;
  font-weight:600;
  cursor: pointer;
  text-decoration: none;
  text-align: center;
}

/* LECTURE PLAYER STYLES */
.lecture-player-section {
  max-width: 1200px;
  margin: 0 auto;
}

.lecture-player-container {
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
  border: 2px solid #1f2d4d;
  position: relative;
  aspect-ratio: 16 / 9;
  width: 100%;
}

.lecture-player {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
}

.lecture-features {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

.lecture-feature-btn {
  padding: 10px 20px;
  background: #0f1b33;
  color: #e2e8f0;
  border: 1px solid #1f2d4d;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  min-width: 90px;
  justify-content: center;
}

.lecture-feature-btn:hover {
  background: #1a2747;
}

.lecture-feature-btn.active {
  background: #10b981;
  color: #071226;
}

/* Lecture List */
.lecture-list {
  margin-top: 30px;
}

.lectures-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.lecture-card {
  background: #0f1b33;
  border: 1px solid #1f2d4d;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s;
}

.lecture-card:hover {
  transform: translateY(-5px);
  border-color: #10b981;
  box-shadow: 0 10px 20px rgba(16, 185, 129, 0.1);
}

.lecture-thumbnail {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-bottom: 1px solid #1f2d4d;
}

.lecture-card-content {
  padding: 15px;
}

.lecture-card-title {
  font-weight: 600;
  color: #e2e8f0;
  margin-bottom: 8px;
  font-size: 16px;
  line-height: 1.4;
}

.lecture-card-description {
  font-size: 13px;
  color: #94a3b8;
  margin-bottom: 15px;
  line-height: 1.5;
}

.lecture-card-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}

.lecture-card-subject {
  font-size: 12px;
  padding: 4px 10px;
  background: rgba(16, 185, 129, 0.1);
  color: #10b981;
  border-radius: 20px;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.play-lecture-btn {
  padding: 10px 20px;
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #071226;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  width: 100%;
  justify-content: center;
  margin-top: 10px;
}

.play-lecture-btn:hover {
  opacity: 0.9;
  transform: scale(1.05);
}

.play-lecture-btn-small {
  padding: 6px 15px;
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #071226;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
}

.play-lecture-btn-small:hover {
  opacity: 0.9;
}

.no-lectures {
  text-align: center;
  padding: 40px;
  color: #94a3b8;
  background: #0f1b33;
  border-radius: 12px;
  border: 1px solid #1f2d4d;
  grid-column: 1 / -1;
}

.lecture-count {
  color: #10b981;
  font-weight: 600;
  margin-left: 5px;
}

/* Hidden URL Display */
.hidden-url {
  display: none;
}

/* POPUP */
#popup {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.popup-box {
  background: #0f1b33;
  padding: 25px;
  width: 90%;
  max-width: 380px;
  border-radius: 18px;
  text-align: center;
  border: 1px solid #1f2d4d;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.popup-thumb {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 12px;
  margin: 15px 0;
  border: 2px solid #10b981;
}
.close-btn {
  margin-top: 20px;
  padding: 12px 24px;
  background: linear-gradient(90deg,#0ea5a4,#10b981);
  color: #0f1b33;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  border: none;
  width: 100%;
  font-size: 16px;
}

/* Search */
.search-container {
  position: relative;
  margin: 20px auto;
  max-width: 600px;
}

.search-input {
  width: 100%;
  padding: 14px 20px 14px 50px;
  background: #0f1b33;
  border: 1px solid #1f2d4d;
  border-radius: 12px;
  color: #e2e8f0;
  font-size: 16px;
  transition: all 0.3s;
}

.search-input:focus {
  outline: none;
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.search-icon {
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  color: #94a3b8;
  font-size: 18px;
}

/* Responsive */
@media (max-width: 768px) {
  .notification-panel {
    width: calc(100vw - 40px);
    right: 10px;
    left: 10px;
  }
  
  .notification-bell {
    top: 10px;
    right: 10px;
    width: 45px;
    height: 45px;
  }
  
  .lectures-grid {
    grid-template-columns: 1fr;
  }
  
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }
  
  .tab-btn {
    padding: 8px 16px;
    font-size: 13px;
  }
}

/* Notification Toast */
.notification-toast {
  position: fixed;
  top: 90px;
  right: 20px;
  background: #0f1b33;
  border: 1px solid #10b981;
  border-radius: 12px;
  padding: 15px;
  width: 320px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  z-index: 1001;
  animation: slideInRight 0.3s ease;
  border-left: 4px solid #10b981;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.toast-icon {
  font-size: 20px;
}

.toast-title {
  font-weight: 600;
  color: #e2e8f0;
  flex: 1;
}

.toast-close {
  background: none;
  border: none;
  color: #94a3b8;
  cursor: pointer;
  font-size: 18px;
}

.toast-message {
  color: #94a3b8;
  font-size: 14px;
  line-height: 1.4;
}
</style>
</head>

<body class="text-white">

<!-- Notification Bell -->
<div class="notification-bell" onclick="toggleNotificationPanel()">
  <i class="fas fa-bell"></i>
  <div id="notification-badge" class="notification-badge" style="display: none;">0</div>
</div>

<!-- Notification Panel -->
<div id="notification-panel" class="notification-panel">
  <div class="notification-header">
    <h3><i class="fas fa-bell"></i> Notifications</h3>
    <div class="notification-actions">
      <button onclick="markAllAsRead()" class="mark-read-btn">
        <i class="fas fa-check"></i> Mark Read
      </button>
      <button onclick="clearAllNotifications()" class="clear-all-btn">
        <i class="fas fa-trash"></i> Clear All
      </button>
    </div>
  </div>
  <div id="notification-list" class="notification-list">
    <div class="no-notifications">
      <i class="fas fa-bell-slash"></i>
      <p>No notifications yet</p>
      <p class="text-sm mt-2">You'll get notifications for study reminders and updates</p>
    </div>
  </div>
</div>

<header class="p-4 text-center text-3xl font-bold text-emerald-400">
  Project 45 â€“ Study Resources
</header>

<!-- Search Bar -->
<div class="search-container px-4">
  <div class="relative">
    <input type="text" id="global-search" 
           placeholder="Search projects, notes, lectures..." 
           class="search-input">
    <i class="fas fa-search search-icon"></i>
  </div>
</div>

<!-- POPUP -->
<div id="popup">
  <div class="popup-box">
    <h2 class="text-xl font-bold mb-2">ðŸŽ‰ New Content Added!</h2>
    <img id="popup-thumb" class="popup-thumb" src="https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Content">
    <p id="popup-title" class="mt-3 text-lg font-semibold text-emerald-300"></p>
    <button class="close-btn" onclick="closePopup()">Continue</button>
  </div>
</div>

<!-- BANNERS -->
<div id="banner-area" class="p-4 space-y-4"></div>

<!-- CATEGORY SELECT -->
<div class="p-4">
  <label class="text-gray-300 text-lg">Select Category:</label>
  <select id="category-filter" class="w-full p-3 rounded bg-[#0d1a33] border border-[#1a2747] text-white mt-2">
    <option value="">All Categories</option>
  </select>
</div>

<!-- TABS -->
<div class="flex justify-center gap-2 my-4 px-4 flex-wrap">
  <button class="tab-btn active" onclick="showSection('projects')">Projects</button>
  <button class="tab-btn" onclick="showSection('notes')">Notes</button>
  <button class="tab-btn" onclick="showSection('dpp')">DPP</button>
  <button class="tab-btn" onclick="showSection('lecture')">Lecture Player</button>
</div>

<div class="p-4">

  <!-- PROJECTS -->
  <div id="projects-section" class="section">
    <h2 class="text-xl font-bold mb-4 text-emerald-300">Projects</h2>
    <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

  <!-- NOTES -->
  <div id="notes-section" class="section hidden">
    <h2 class="text-xl font-bold mb-4 text-emerald-300">Notes</h2>
    <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

  <!-- DPP -->
  <div id="dpp-section" class="section hidden">
    <h2 class="text-xl font-bold mb-4 text-emerald-300">Daily Practice Papers</h2>
    <div id="dpp-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

  <!-- LECTURE PLAYER -->
  <div id="lecture-section" class="section hidden lecture-player-section">
    <h2 class="text-xl font-bold mb-6 text-emerald-300 text-center">Lecture Player</h2>
    
    <!-- Hidden URL input -->
    <div class="hidden-url">
      <input type="text" id="lectureUrl" value="">
    </div>
    
    <!-- 16:9 Video Player -->
    <div class="lecture-player-container">
      <div id="lecture-player"></div>
    </div>
    
    <!-- Speed Controls -->
    <div class="lecture-features">
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(0.75)">
        <i class="fas fa-tachometer-alt"></i> 0.75x
      </button>
      <button class="lecture-feature-btn active" onclick="setPlaybackSpeed(1)">
        <i class="fas fa-tachometer-alt"></i> 1x Normal
      </button>
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(1.25)">
        <i class="fas fa-tachometer-alt"></i> 1.25x
      </button>
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(1.5)">
        <i class="fas fa-tachometer-alt"></i> 1.5x
      </button>
      <button class="lecture-feature-btn" onclick="setPlaybackSpeed(2)">
        <i class="fas fa-tachometer-alt"></i> 2x
      </button>
      <button class="lecture-feature-btn" onclick="skipBackward()">
        <i class="fas fa-backward"></i> -15s
      </button>
      <button class="lecture-feature-btn" onclick="skipForward()">
        <i class="fas fa-forward"></i> +15s
      </button>
    </div>
    
    <!-- All Lectures from Firebase -->
    <div class="lecture-list">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-emerald-300">All Lectures <span id="lecture-count" class="lecture-count">0</span></h3>
        <div class="text-sm text-gray-400">
          <i class="fas fa-mouse-pointer mr-1"></i> Click any lecture to play
        </div>
      </div>
      <div id="lectures-grid-container" class="lectures-grid">
        <!-- All lectures will be loaded here from Firebase -->
        <div class="no-lectures">
          <i class="fas fa-video-slash text-4xl mb-3"></i>
          <p>No lectures added yet.</p>
          <p class="text-sm mt-2">Check back soon for new lectures!</p>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
// ---------------- FIREBASE ----------------
const firebaseConfig = {
  apiKey: "AIzaSyA8Ck4k7gMfn9oU1nq-JBijML1JE6yVx84",
  authDomain: "project45-627cc.firebaseapp.com",
  databaseURL: "https://project45-627cc-default-rtdb.firebaseio.com",
  projectId: "project45-627cc",
  storageBucket: "project45-627cc.appspot.com",
  messagingSenderId: "850515567224",
  appId: "1:850515567224:web:bcbed252ee8596c08fc38d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let allCategories = {}, allProjects = {}, allNotes = {}, allDpp = {}, allLectures = {};
let allNotifications = {};
let unreadNotifications = 0;
let notificationHistory = [];
let firstLoad = true;

// Store lecture to play when switching to lecture tab
let lectureToPlay = null;

// Initialize notification badge from localStorage
function initNotificationBadge() {
  const saved = localStorage.getItem('project45_unread_count');
  if (saved) {
    unreadNotifications = parseInt(saved) || 0;
    updateNotificationBadge();
  }
}

// Notification Functions
function toggleNotificationPanel() {
  const panel = document.getElementById('notification-panel');
  if (panel.style.display === 'block') {
    panel.style.display = 'none';
  } else {
    panel.style.display = 'block';
    // Mark all as read when opened
    markAllAsRead();
  }
}

function markAllAsRead() {
  unreadNotifications = 0;
  updateNotificationBadge();
  localStorage.setItem('project45_unread_count', '0');
  
  // Update UI to remove unread styling
  document.querySelectorAll('.notification-item.unread').forEach(item => {
    item.classList.remove('unread');
  });
}

function clearAllNotifications() {
  if (confirm('Clear all notifications?')) {
    notificationHistory = [];
    localStorage.setItem('project45_notifications', JSON.stringify([]));
    renderNotificationsList();
    unreadNotifications = 0;
    updateNotificationBadge();
  }
}

function updateNotificationBadge() {
  const badge = document.getElementById('notification-badge');
  if (unreadNotifications > 0) {
    badge.style.display = 'flex';
    badge.textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
  } else {
    badge.style.display = 'none';
  }
}

function showNotificationToast(title, message, icon = 'ðŸ””') {
  // Remove existing toast
  const existingToast = document.querySelector('.notification-toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast
  const toast = document.createElement('div');
  toast.className = 'notification-toast';
  toast.innerHTML = `
    <div class="toast-header">
      <span class="toast-icon">${icon}</span>
      <span class="toast-title">${title}</span>
      <button class="toast-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
    </div>
    <div class="toast-message">${message}</div>
  `;
  
  document.body.appendChild(toast);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 5000);
}

function addNotificationToHistory(notification) {
  const now = new Date();
  const notificationObj = {
    id: 'n_' + Date.now(),
    title: notification.title,
    message: notification.message,
    icon: notification.icon || 'ðŸ””',
    timestamp: notification.timestamp || Date.now(),
    type: notification.type || 'scheduled',
    read: false,
    timeStr: now.toLocaleTimeString('en-IN', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    }),
    dateStr: now.toLocaleDateString('en-IN', {
      day: 'numeric',
      month: 'short'
    })
  };
  
  // Add to beginning of array (newest first)
  notificationHistory.unshift(notificationObj);
  
  // Keep only last 100 notifications
  if (notificationHistory.length > 100) {
    notificationHistory = notificationHistory.slice(0, 100);
  }
  
  // Save to localStorage
  localStorage.setItem('project45_notifications', JSON.stringify(notificationHistory));
  
  // Update UI
  unreadNotifications++;
  updateNotificationBadge();
  renderNotificationsList();
  
  // Show toast
  showNotificationToast(notification.title, notification.message, notification.icon);
  
  // Request notification permission and show if granted
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification(notification.title, { 
      body: notification.message, 
      icon: '/favicon.ico',
      tag: 'project45_notification'
    });
  }
}

function renderNotificationsList() {
  const list = document.getElementById('notification-list');
  
  if (notificationHistory.length === 0) {
    list.innerHTML = `
      <div class="no-notifications">
        <i class="fas fa-bell-slash"></i>
        <p>No notifications yet</p>
        <p class="text-sm mt-2">You'll get notifications for study reminders and updates</p>
      </div>
    `;
    return;
  }
  
  list.innerHTML = '';
  
  notificationHistory.forEach(notification => {
    const item = document.createElement('div');
    item.className = `notification-item ${notification.read ? '' : 'unread'}`;
    item.innerHTML = `
      <div class="notification-content">
        <div class="notification-icon">${notification.icon}</div>
        <div class="notification-text">
          <div class="notification-title">${notification.title}</div>
          <div class="notification-message">${notification.message}</div>
          <div class="notification-meta">
            <div class="notification-time">${notification.dateStr} â€¢ ${notification.timeStr}</div>
            <div class="notification-type">${notification.type}</div>
          </div>
        </div>
      </div>
    `;
    
    item.addEventListener('click', () => {
      if (!notification.read) {
        notification.read = true;
        unreadNotifications = Math.max(0, unreadNotifications - 1);
        updateNotificationBadge();
        localStorage.setItem('project45_unread_count', unreadNotifications);
        localStorage.setItem('project45_notifications', JSON.stringify(notificationHistory));
        item.classList.remove('unread');
      }
    });
    
    list.appendChild(item);
  });
}

function loadSavedNotifications() {
  const saved = localStorage.getItem('project45_notifications');
  if (saved) {
    try {
      notificationHistory = JSON.parse(saved) || [];
      
      // Count unread notifications
      unreadNotifications = notificationHistory.filter(n => !n.read).length;
      updateNotificationBadge();
      
      // Render list
      renderNotificationsList();
    } catch (e) {
      console.error('Error loading saved notifications:', e);
      notificationHistory = [];
    }
  }
}

function requestNotificationPermission() {
  if ("Notification" in window) {
    if (Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          console.log("Notification permission granted");
        }
      });
    }
  }
}

function showSection(sec){
  // Update tab buttons
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.classList.remove("active");
  });
  event.currentTarget.classList.add("active");
  
  // Show selected section
  document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
  document.getElementById(sec + "-section").classList.remove("hidden");
  
  // If switching to lecture tab and there's a lecture to play
  if (sec === 'lecture' && lectureToPlay) {
    // Small delay to ensure player is loaded
    setTimeout(() => {
      playLecture(lectureToPlay.videoId, lectureToPlay.title);
      lectureToPlay = null; // Reset after playing
    }, 500);
  }
}

// -------------- POPUP -----------------
function openPopup(title, thumb){
  document.getElementById("popup-title").innerText = title;
  document.getElementById("popup-thumb").src = thumb;
  document.getElementById("popup").style.display = "flex";
}

function closePopup(){
  document.getElementById("popup").style.display = "none";
}

// ----------- BANNERS ----------- 
function loadBanners(){
  const area = document.getElementById("banner-area");
  area.innerHTML = "";

  db.ref("banners").on("value", snap => {
    area.innerHTML = "";
    snap.forEach(child => {
      const url = child.val().url;
      if(url) {
        area.innerHTML += `<img src="${url}" class="banner-slide" onerror="this.src='https://via.placeholder.com/1200x300/0f1b33/10b981?text=Study+Resources'">`;
      }
    });
    
    // If no banners, show placeholder
    if(area.innerHTML === "") {
      area.innerHTML = `
        <div class="banner-slide bg-gradient-to-r from-emerald-900 to-teal-800 flex items-center justify-center rounded-2xl">
          <div class="text-center">
            <p class="text-2xl font-bold mb-2">Welcome to Project 45</p>
            <p class="text-emerald-200">Study Resources & Lectures</p>
          </div>
        </div>
      `;
    }
  });
}

// ----------- CATEGORY DROPDOWN ----------- 
function loadCategories(){
  const select = document.getElementById("category-filter");
  select.innerHTML = `<option value="">All Categories</option>`;

  db.ref("categories").on("value", snap => {
    select.innerHTML = `<option value="">All Categories</option>`;
    snap.forEach(child => {
      const name = child.val().name;
      allCategories[child.key] = name;
      select.innerHTML += `<option value="${name}">${name}</option>`;
    });
    renderAll();
  });

  select.addEventListener("change", renderAll);
}

// ----------- PROJECTS ----------- 
function renderProjects(){
  const list = document.getElementById("projects-list");
  const filter = document.getElementById("category-filter").value;
  const search = document.getElementById("global-search").value.toLowerCase();
  list.innerHTML = "";

  let hasResults = false;

  Object.entries(allProjects).forEach(([id, p]) => {
    if(filter && p.category !== filter) return;
    if(search && !p.title.toLowerCase().includes(search)) return;

    hasResults = true;
    
    // Check if this project has a video URL (lecture)
    const hasLecture = p.videoUrl || p.lectureUrl || p.watchLink;
    const videoId = extractVideoIdFromUrl(hasLecture);
    
    list.innerHTML += `
      <div class="card">
        <img src="${p.posterUrl || 'https://via.placeholder.com/300x160/0f1b33/10b981?text=Project'}" 
             class="poster" alt="${p.title}"
             onerror="this.src='https://via.placeholder.com/300x160/0f1b33/10b981?text=Project'">
        <div class="p-3">
          <p class="font-bold text-sm mb-1">${p.title}</p>
          <p class="text-gray-400 text-xs mb-2">${p.year || ''} â€¢ ${p.category || 'General'}</p>
          <p class="text-gray-300 text-xs mb-3 line-clamp-2">${p.description || ''}</p>
          ${hasLecture && videoId ? 
            `<button onclick="playLectureFromHome('${videoId}', '${p.title.replace(/'/g, "\\'")}')" class="open-link text-xs w-full">Watch Lecture</button>` : 
            '<p class="text-gray-500 text-xs text-center py-2">No lecture available</p>'
          }
        </div>
      </div>
    `;
  });
  
  if(!hasResults) {
    list.innerHTML = `
      <div class="col-span-2 text-center p-8">
        <i class="fas fa-search text-4xl text-gray-400 mb-3"></i>
        <p class="text-gray-400">No projects found</p>
        ${search ? '<p class="text-sm text-gray-500 mt-1">Try a different search term</p>' : ''}
      </div>
    `;
  }
}

// ----------- NOTES ----------- 
function renderNotes(){
  const list = document.getElementById("notes-list");
  const filter = document.getElementById("category-filter").value;
  const search = document.getElementById("global-search").value.toLowerCase();
  list.innerHTML = "";

  let hasResults = false;

  Object.entries(allNotes).forEach(([id, n]) => {
    if(filter && n.category !== filter) return;
    if(search && !n.title.toLowerCase().includes(search)) return;

    hasResults = true;

    list.innerHTML += `
      <div class="card p-4">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-12 h-12 bg-emerald-900 rounded-lg flex items-center justify-center">
            <i class="fas fa-file-pdf text-emerald-300 text-xl"></i>
          </div>
          <div>
            <p class="font-bold text-sm">${n.title}</p>
            <p class="text-gray-400 text-xs">${n.category || 'General'}</p>
          </div>
        </div>
        ${n.url ? 
          `<a href="${n.url}" target="_blank" class="open-link text-xs flex items-center justify-center gap-2">
            <i class="fas fa-external-link-alt"></i> Open Notes
          </a>` : 
          '<p class="text-gray-500 text-xs text-center">Link coming soon</p>'
        }
      </div>
    `;
  });
  
  if(!hasResults) {
    list.innerHTML = `
      <div class="col-span-2 text-center p-8">
        <i class="fas fa-file-alt text-4xl text-gray-400 mb-3"></i>
        <p class="text-gray-400">No notes found</p>
        ${search ? '<p class="text-sm text-gray-500 mt-1">Try a different search term</p>' : ''}
      </div>
    `;
  }
}

// ----------- DPP ----------- 
function renderDpp(){
  const list = document.getElementById("dpp-list");
  const filter = document.getElementById("category-filter").value;
  const search = document.getElementById("global-search").value.toLowerCase();
  list.innerHTML = "";

  let hasResults = false;

  Object.entries(allDpp).forEach(([id, d]) => {
    if(filter && d.category !== filter) return;
    if(search && !d.title.toLowerCase().includes(search)) return;

    hasResults = true;

    list.innerHTML += `
      <div class="card p-4">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-12 h-12 bg-blue-900 rounded-lg flex items-center justify-center">
            <i class="fas fa-book text-blue-300 text-xl"></i>
          </div>
          <div>
            <p class="font-bold text-sm">${d.title}</p>
            <p class="text-gray-400 text-xs">${d.category || 'General'}</p>
          </div>
        </div>
        ${d.url ? 
          `<a href="${d.url}" target="_blank" class="open-link text-xs flex items-center justify-center gap-2" style="background:linear-gradient(90deg,#3b82f6,#1d4ed8);">
            <i class="fas fa-external-link-alt"></i> Open DPP
          </a>` : 
          '<p class="text-gray-500 text-xs text-center">Link coming soon</p>'
        }
      </div>
    `;
  });
  
  if(!hasResults) {
    list.innerHTML = `
      <div class="col-span-2 text-center p-8">
        <i class="fas fa-book text-4xl text-gray-400 mb-3"></i>
        <p class="text-gray-400">No DPPs found</p>
        ${search ? '<p class="text-sm text-gray-500 mt-1">Try a different search term</p>' : ''}
      </div>
    `;
  }
}

// ----------- ALL LECTURES ----------- 
function renderAllLectures() {
  const grid = document.getElementById("lectures-grid-container");
  const countElement = document.getElementById("lecture-count");
  const search = document.getElementById("global-search").value.toLowerCase();
  
  // Convert to array
  const lecturesArray = Object.entries(allLectures);
  
  // Filter by search
  const filteredLectures = search ? lecturesArray.filter(([id, lecture]) => 
    lecture.title.toLowerCase().includes(search) || 
    lecture.description.toLowerCase().includes(search) ||
    lecture.category.toLowerCase().includes(search)
  ) : lecturesArray;
  
  // Update count
  countElement.textContent = filteredLectures.length;
  
  if (filteredLectures.length === 0) {
    grid.innerHTML = `
      <div class="no-lectures">
        <i class="fas fa-video-slash text-4xl mb-3"></i>
        <p>No lectures found</p>
        <p class="text-sm mt-2">${search ? 'Try a different search term' : 'Check back soon for new lectures!'}</p>
      </div>
    `;
    return;
  }
  
  // Sort by timestamp if available
  filteredLectures.sort((a, b) => {
    const timeA = a[1].timestamp || a[1].createdAt || 0;
    const timeB = b[1].timestamp || b[1].createdAt || 0;
    return timeB - timeA; // Newest first
  });
  
  // Clear grid
  grid.innerHTML = '';
  
  // Display all lectures in grid
  filteredLectures.forEach(([id, lecture]) => {
    const videoId = extractVideoIdFromUrl(lecture.videoUrl || lecture.url || lecture.watchLink);
    if (!videoId) return;
    
    // Get YouTube thumbnail
    const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    
    // Get subject/tag
    const subject = lecture.subject || lecture.category || 'General';
    
    // Format description
    const description = lecture.description 
      ? (lecture.description.length > 100 
        ? lecture.description.substring(0, 100) + '...' 
        : lecture.description)
      : 'Educational lecture video';
    
    grid.innerHTML += `
      <div class="lecture-card">
        <img src="${thumbnailUrl}" 
             class="lecture-thumbnail" 
             alt="${lecture.title || 'Lecture'}"
             onerror="this.src='https://via.placeholder.com/300x180/0f1b33/10b981?text=Lecture'">
        <div class="lecture-card-content">
          <h4 class="lecture-card-title">${lecture.title || 'Untitled Lecture'}</h4>
          <p class="lecture-card-description">${description}</p>
          
          <div class="lecture-card-meta">
            <span class="lecture-card-subject">${subject}</span>
            <span class="text-xs text-gray-400 flex items-center gap-1">
              <i class="far fa-clock"></i> ${lecture.duration || '--:--'}
            </span>
          </div>
          
          <button class="play-lecture-btn" 
                  onclick="playLecture('${videoId}', '${(lecture.title || 'Untitled').replace(/'/g, "\\'")}')">
            <i class="fas fa-play"></i> Play Lecture
          </button>
        </div>
      </div>
    `;
  });
}

// Search functionality
document.getElementById('global-search').addEventListener('input', function() {
  renderAll();
});

function renderAll() {
  renderProjects();
  renderNotes();
  renderDpp();
  renderAllLectures();
}

// ----------- LIVE FIREBASE DATA ----------- 
function startLive() {
  // Load projects
  db.ref("projects").on("value", snap => {
    const oldCount = Object.keys(allProjects).length;
    allProjects = snap.val() || {};
    const newCount = Object.keys(allProjects).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allProjects).slice(-1)[0];
      const thumbnail = lastItem.posterUrl || 
                       "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Project";
      openPopup(lastItem.title || "New Project Added", thumbnail);
    }
    renderProjects();
  });

  // Load notes
  db.ref("notes").on("value", snap => {
    const oldCount = Object.keys(allNotes).length;
    allNotes = snap.val() || {};
    const newCount = Object.keys(allNotes).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allNotes).slice(-1)[0];
      const thumbnail = lastItem.thumbnail || 
                       lastItem.posterUrl || 
                       "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Notes";
      openPopup(lastItem.title || "New Notes Added", thumbnail);
    }
    renderNotes();
  });

  // Load DPP
  db.ref("dpp").on("value", snap => {
    const oldCount = Object.keys(allDpp).length;
    allDpp = snap.val() || {};
    const newCount = Object.keys(allDpp).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allDpp).slice(-1)[0];
      const thumbnail = lastItem.thumbnail || 
                       lastItem.posterUrl || 
                       "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+DPP";
      openPopup(lastItem.title || "New DPP Added", thumbnail);
    }
    renderDpp();
  });

  // Load lectures
  db.ref("lectures").on("value", snap => {
    const oldCount = Object.keys(allLectures).length;
    allLectures = snap.val() || {};
    const newCount = Object.keys(allLectures).length;

    if (!firstLoad && newCount > oldCount) {
      const lastItem = Object.values(allLectures).slice(-1)[0];
      const videoId = extractVideoIdFromUrl(lastItem.videoUrl || lastItem.url || lastItem.watchLink);
      const thumbnail = videoId 
        ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`
        : lastItem.thumbnail || 
          lastItem.posterUrl || 
          "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Lecture";
      
      openPopup(lastItem.title || "New Lecture Added", thumbnail);
    }
    
    renderAllLectures();
  });

  // Load scheduled notifications from Firebase
  db.ref("notifications").on("value", snap => {
    allNotifications = snap.val() || {};
  });

  // Load notification history from Firebase
  db.ref("notification_history").on("value", snap => {
    const history = snap.val() || {};
    const now = Date.now();
    const oneDayAgo = now - (24 * 60 * 60 * 1000);
    
    Object.entries(history).forEach(([id, notification]) => {
      // Only show notifications from last 24 hours that we haven't seen
      if (notification.timestamp > oneDayAgo) {
        const notificationKey = `seen_${id}`;
        const hasSeen = localStorage.getItem(notificationKey);
        
        if (!hasSeen) {
          addNotificationToHistory(notification);
          localStorage.setItem(notificationKey, 'true');
        }
      }
    });
  });

  firstLoad = false;
}

// ================= LECTURE PLAYER =================
// Load YouTube IFrame API
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var lecturePlayer;
let currentSpeed = 1;

function extractVideoIdFromUrl(url) {
  if (!url) return null;
  
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
    /^([a-zA-Z0-9_-]{11})$/
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match && match[1]) {
      return match[1];
    }
  }
  
  return null;
}

function onYouTubeIframeAPIReady() {
  lecturePlayer = new YT.Player('lecture-player', {
    height: '100%',
    width: '100%',
    videoId: '', // Start empty
    playerVars: {
      'autoplay': 0,
      'controls': 1,
      'rel': 0,
      'modestbranding': 1,
      'showinfo': 0,
      'iv_load_policy': 3,
      'enablejsapi': 1
    },
    events: {
      'onReady': onLecturePlayerReady,
      'onStateChange': onLectureStateChange
    }
  });
}

function onLecturePlayerReady(event) {
  console.log("Lecture Player ready");
  event.target.setPlaybackRate(currentSpeed);
  
  // Load first lecture if available
  const lecturesArray = Object.values(allLectures);
  if (lecturesArray.length > 0) {
    const firstLecture = lecturesArray[0];
    const videoId = extractVideoIdFromUrl(firstLecture.videoUrl || firstLecture.url || firstLecture.watchLink);
    if (videoId) {
      document.getElementById('lectureUrl').value = videoId;
      event.target.loadVideoById(videoId);
    }
  }
}

function onLectureStateChange(event) {
  // Player state change handler
}

function playLecture(videoId, title = '') {
  if (!videoId) return;
  
  // Set the hidden input value
  document.getElementById('lectureUrl').value = videoId;
  
  // Load and play the video
  if (lecturePlayer && lecturePlayer.loadVideoById) {
    lecturePlayer.loadVideoById(videoId);
    lecturePlayer.setPlaybackRate(currentSpeed);
    
    // Update page title if provided
    if (title) {
      document.title = `Playing: ${title} - Project 45`;
    }
    
    // Scroll player into view
    document.querySelector('.lecture-player-container').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }
}

function playLectureFromHome(videoId, title) {
  // Store lecture info and switch to lecture tab
  lectureToPlay = { videoId, title };
  showSection('lecture');
}

function setPlaybackSpeed(speed) {
  currentSpeed = speed;
  if (lecturePlayer && lecturePlayer.setPlaybackRate) {
    lecturePlayer.setPlaybackRate(speed);
  }
  
  // Update active button
  document.querySelectorAll('.lecture-feature-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
}

function skipBackward() {
  if (!lecturePlayer || !lecturePlayer.getCurrentTime) return;
  const currentTime = lecturePlayer.getCurrentTime();
  lecturePlayer.seekTo(Math.max(0, currentTime - 15), true);
}

function skipForward() {
  if (!lecturePlayer || !lecturePlayer.getCurrentTime) return;
  const currentTime = lecturePlayer.getCurrentTime();
  lecturePlayer.seekTo(currentTime + 15, true);
}

// INITIALIZE EVERYTHING
window.onload = function() {
  // Load saved notifications first
  loadSavedNotifications();
  initNotificationBadge();
  
  // Request notification permission
  requestNotificationPermission();
  
  // Load all data
  loadBanners();
  loadCategories();
  startLive();
  
  // Show projects by default
  showSection('projects');
  
  // Add error handling for images
  document.getElementById('popup-thumb').onerror = function() {
    this.src = "https://via.placeholder.com/350x180/0f1b33/10b981?text=New+Content";
  };
  
  // Close notification panel when clicking outside
  document.addEventListener('click', function(event) {
    const panel = document.getElementById('notification-panel');
    const bell = document.querySelector('.notification-bell');
    
    if (panel.style.display === 'block' && 
        !panel.contains(event.target) && 
        !bell.contains(event.target)) {
      panel.style.display = 'none';
    }
  });
  
  // Show welcome notification on first visit
  const hasVisited = localStorage.getItem('project45_has_visited');
  if (!hasVisited) {
    setTimeout(() => {
      addNotificationToHistory({
        title: "Welcome to Project 45! ðŸ‘‹",
        message: "Start exploring study resources and lectures. We'll send you study reminders throughout the day!",
        icon: "ðŸŽ“",
        type: "welcome"
      });
      localStorage.setItem('project45_has_visited', 'true');
    }, 3000);
  }
  
  // Check for scheduled notifications every minute
  setInterval(() => {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    
    Object.values(allNotifications || {}).forEach(notification => {
      if (notification.active && 
          notification.hour === currentHour && 
          notification.minute === currentMinute) {
        
        // Check if we already showed this notification today
        const notificationKey = `notif_${notification.hour}_${notification.minute}_${now.toDateString()}`;
        const hasShown = localStorage.getItem(notificationKey);
        
        if (!hasShown) {
          addNotificationToHistory(notification);
          localStorage.setItem(notificationKey, 'true');
        }
      }
    });
  }, 60000); // Check every minute
};
</script>
</body>
</html>
